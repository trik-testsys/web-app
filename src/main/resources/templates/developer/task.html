<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru" th:charset="utf-8">
<head>
    <th:block th:include="fragments/layout :: head('Задача')"></th:block>
</head>
<body>
<header th:replace="fragments/layout :: header(userName=${user.name})"></header>
<aside th:replace="fragments/layout :: sidebar(sections=${menuSections})"></aside>

<main class="app-main">
    <section class="card">
        <h2 class="card-title"><a th:href="@{/user/developer/tasks}">Задачи</a> / <span th:text="${task.name}"></span></h2>
        <div class="card-body">
            <div class="alert" th:if="${message}" th:text="${message}"></div>
            <form id="task-form" data-readonly-toggle th:action="@{'/user/developer/tasks/' + ${task.id} + '/update'}" method="post" class="form" style="display:grid; gap:12px; max-width:720px;">
                <label>
                    <div style="margin-bottom:4px;">Название<span class="req">*</span></div>
                    <input name="name" type="text" th:value="${task.name}" required disabled style="width:100%; padding:10px; border:1px solid #dde3ea; border-radius:8px;">
                </label>
                <label>
                    <div style="margin-bottom:4px;">Описание</div>
                    <textarea name="info" rows="3" th:text="${task.info}" disabled style="width:100%; padding:10px; border:1px solid #dde3ea; border-radius:8px;"></textarea>
                </label>
                <div class="form-buttons">
                    <button type="button" class="button edit-button" onclick="window.App.enableForm('task-form')">Редактировать</button>
                    <button type="submit" class="button button--primary save-button" style="display:none;">Сохранить</button>
                    <button type="button" class="button cancel-button" style="display:none;" onclick="window.App.disableForm('task-form')">Отмена</button>
                </div>
            </form>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Доступ для Групп Пользователей</h2>
        <div class="card-body">
            <div th:if="${#lists.isEmpty(task.userGroups)}" style="color: var(--color-text-muted);">Доступно только Вам</div>
            <ul th:if="${!#lists.isEmpty(task.userGroups)}" class="pill-list">
                <li class="pill" th:each="g : ${task.userGroups}">
                    <span th:text="${(g.name ?: 'Без названия') + ' (#' + g.id + ')'}"></span>
                </li>
            </ul>

            <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                <form th:action="@{'/user/developer/tasks/' + ${task.id} + '/groups/add'}" method="post" style="display:flex; gap:8px; align-items:center;" onsubmit="return confirm('Данное действие нельзя будет отменить в будущем');">
                    <select name="groupId" required style="min-width:240px; padding:6px; border:1px solid #dde3ea; border-radius:8px;">
                        <option th:each="g : ${availableUserGroups}" th:value="${g.id}" th:text="${(g.name ?: 'Без названия') + ' (#' + g.id + ')'}"></option>
                    </select>
                    <button class="button" type="submit">Добавить группу</button>
                </form>
            </div>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Тестирование</h2>
        <div class="card-body">
            <div style="margin-bottom:10px;">
                <strong>Готовность к тестированию:</strong>
                <span th:text="${testReady ? 'Готова' : 'Не готова'}"></span>
                <span class="field-note">(Полигоны: <span th:text="${numPolygons}"></span>; Решения: <span th:text="${numSolutions}"></span>)</span>
            </div>
            <div style="margin-bottom:10px;">
                <strong>Статус тестирования:</strong>
                <span th:text="${testStatus}"></span>
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
                <a class="button" th:href="@{'/user/developer/tasks/' + ${task.id} + '/tests'}">Результаты тестирования</a>
                <form th:action="@{'/user/developer/tasks/' + ${task.id} + '/test'}" method="post" onsubmit="return confirm('Отправить Задачу на тестирование?');">
                    <button class="button button--primary" type="submit" th:disabled="${!testReady || isTesting || isUsedInAnyContest}">Запустить тестирование</button>
                </form>
            </div>
            <div class="field-note" style="margin-top:8px;">Для тестирования требуется минимум один Полигон и одно Эталонное Решение.</div>
            <div class="field-note" style="margin-top:8px;">Для прикрепления к Туру требуется минимум один Полигон, одно Эталонное Решение и одно Упражнение.</div>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Файлы</h2>
        <div class="card-body">

            <h3 style="margin: 0 0 8px 0;">Прикрепленные</h3>
            <div th:if="${#lists.isEmpty(attachedTaskFiles)}" style="color: var(--color-text-muted);">Пока нет прикреплённых файлов.</div>
            <table th:if="${!#lists.isEmpty(attachedTaskFiles)}" class="table">
                <thead>
                    <tr>
                        <th class="id-cell">ID</th>
                        <th>Название</th>
                        <th>Тип</th>
                        <th class="date-cell">Дата создания</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="f : ${attachedTaskFiles}">
                        <td class="id-cell" th:text="${f.id}"></td>
                        <td><a th:href="@{'/user/developer/task-files/' + ${f.id}}" th:text="${f.name}"></a></td>
                        <td th:text="${f.localizedType}"></td>
                        <td class="date-cell" data-utc th:attr="data-utc=${f.createdAt}" th:text="${f.createdAt != null ? #temporals.format(f.createdAt, 'dd.MM.yyyy HH:mm') : '—'}"></td>
                        <td>
                            <form th:action="@{'/user/developer/tasks/' + ${task.id} + '/files/' + ${f.id} + '/detach'}" method="post" onsubmit="return confirm('Открепить файл?');">
                                <button class="button" type="submit" th:disabled="${isTesting || isUsedInAnyContest}">Открепить</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>

            <hr class="separator">

            <h3 style="margin: 0 0 8px 0;">Доступные к прикреплению</h3>
            <div th:if="${#lists.isEmpty(availableTaskFiles)}" style="color: var(--color-text-muted);">Нет доступных файлов для прикрепления.</div>
            <table th:if="${!#lists.isEmpty(availableTaskFiles)}" class="table">
                <thead>
                <tr>
                    <th class="id-cell">ID</th>
                    <th>Название</th>
                    <th>Тип</th>
                    <th class="date-cell">Дата создания</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="f : ${availableTaskFiles}">
                    <td class="id-cell" th:text="${f.id}"></td>
                    <td><a th:href="@{'/user/developer/task-files/' + ${f.id}}" th:text="${f.name}"></a></td>
                    <td th:text="${f.localizedType}"></td>
                    <td class="date-cell" data-utc th:attr="data-utc=${f.createdAt}" th:text="${f.createdAt != null ? #temporals.format(f.createdAt, 'dd.MM.yyyy HH:mm') : '—'}"></td>
                    <td>
                        <form th:action="@{'/user/developer/tasks/' + ${task.id} + '/files/attach'}" method="post">
                            <input type="hidden" name="taskFileId" th:value="${f.id}">
                            <button class="button" type="submit" th:disabled="${isTesting || isUsedInAnyContest}">Прикрепить</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Туры, к которым прикреплена</h2>
        <div class="card-body">
            <div th:if="${#lists.isEmpty(attachedContests)}" style="color: var(--color-text-muted);">Пока нет прикреплённых Туров.</div>
            <table th:if="${!#lists.isEmpty(attachedContests)}" class="table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th class="date-cell">Начало</th>
                    <th class="date-cell">Окончание</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="c : ${attachedContests}">
                    <td th:text="${c.id}"></td>
                    <td><a th:href="@{'/user/developer/contests/' + ${c.id}}" th:text="${c.name}"></a></td>
                    <td class="date-cell" data-utc th:attr="data-utc=${c.startsAt}" th:text="${c.startsAt != null ? #temporals.format(c.startsAt, 'dd.MM.yyyy HH:mm') : '—'}"></td>
                    <td class="date-cell" data-utc th:attr="data-utc=${c.endsAt}" th:text="${c.endsAt != null ? #temporals.format(c.endsAt, 'dd.MM.yyyy HH:mm') : '—'}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</main>

<footer th:replace="fragments/layout :: footer"></footer>
</body>
</html>



